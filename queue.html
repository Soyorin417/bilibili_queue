<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" name="referrer" content="no-referrer">
<title>OBS 直播排队显示</title>
<style>
/* Use CSS variables generated by queue_ui.html when available; provide sensible fallbacks */
*{box-sizing: border-box}
body {
    font-family: "Microsoft YaHei", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: transparent; /* 页面背景透明 */
    color: var(--queue-color, #fff);
    padding: 20px;
}

#preview {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 10px;
    border: 1px solid #444;
    background: rgba(0,0,0,var(--queue-bg-opacity,0.2));
}

.queue-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    border-left: 5px solid var(--queue-border-color, #1E90FF);
    border-radius: 8px;
    font-size: var(--queue-font-size, 36px);
    color: var(--queue-color, #fff);
    margin-bottom: 5px;
}

.queue-item img {
    width: var(--queue-avatar-size, 50px);
    height: var(--queue-avatar-size, 50px);
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

.empty {
    font-size: var(--queue-font-size, 36px);
    color: #aaa;
    text-align: center;
    padding: 20px;
}
</style>
</head>
<body>
<div id="preview"></div>
<div id="error" style="margin-top:10px;color:#f88"></div>

<script>
let currentQueue = [];
// 备用示例数据（当无法 fetch 时可用）
const SAMPLE_FALLBACK = [
    {uid: 1, uname: "小明", face: "default_avatar.png", color: "#ff6b6b"},
    {uid: 2, uname: "小红", face: "default_avatar.png", color: "#6bff95"},
    {uid: 3, uname: "张三", face: "default_avatar.png", color: "#6bc2ff"}
];

async function updateQueue() {
    try {
        const res = await fetch("queue.json?_=" + Date.now());
        const arr = await res.json();
        const listEl = document.getElementById("preview");
        document.getElementById('error').textContent = '';

        if (!arr || arr.length === 0) {
            listEl.innerHTML = '<div class="empty">（无人）</div>';
            currentQueue = [];
            return;
        }

        // 删除已离开的用户
        for (let i = currentQueue.length - 1; i >= 0; i--) {
            if (!arr.find(u => u.uid === currentQueue[i].uid)) {
                const el = document.getElementById("user-" + currentQueue[i].uid);
                if (el) listEl.removeChild(el);
            }
        }

        // 更新或新增用户
        arr.forEach((user, index) => {
            let itemEl = document.getElementById("user-" + user.uid);
            if (!itemEl) {
                // 新用户，创建元素
                itemEl = document.createElement("div");
                itemEl.className = "queue-item";
                itemEl.id = "user-" + user.uid;

                const img = document.createElement("img");
                img.src = user.face || "default_avatar.png"; // 只赋值一次
                img.alt = user.uname;

                const span = document.createElement("span");
                // keep uname in dataset so style generator can use it if needed
                span.dataset.uname = user.uname;
                itemEl.appendChild(img);
                itemEl.appendChild(span);
                // store color for UI generator compatibility
                itemEl.dataset.color = user.color || "#1E90FF";
                listEl.appendChild(itemEl);
            }

            // 只更新文字，不重新赋值头像
            const span = itemEl.querySelector("span");
            span.textContent = `${index + 1}. ${user.uname}`;
        });

        currentQueue = arr;
    } catch (e) {
        console.error("读取 queue.json 失败:", e);
        const errEl = document.getElementById('error');
        let msg = '读取 queue.json 失败';
        if (e && e.message) msg += ': ' + e.message;
        // 显示错误并提供重试/示例按钮
        errEl.innerHTML = `<div>${msg}。<button id=\"retryBtn\">重试</button> <button id=\"sampleBtn\">加载示例数据</button></div>`;
        document.getElementById('retryBtn').onclick = () => { errEl.textContent = ''; updateQueue(); };
        document.getElementById('sampleBtn').onclick = () => { loadSampleData(); };
        const listEl = document.getElementById("preview");
        listEl.innerHTML = '<div class="empty">读取失败</div>';
    }
}

function loadSampleData(){
    const listEl = document.getElementById('preview');
    listEl.innerHTML = '';
    SAMPLE_FALLBACK.forEach((user, index)=>{
        let itemEl = document.createElement('div');
        itemEl.className = 'queue-item';
        itemEl.id = 'user-' + user.uid;
        const img = document.createElement('img'); img.src = user.face; img.alt = user.uname;
        const span = document.createElement('span'); span.dataset.uname = user.uname; span.textContent = `${index+1}. ${user.uname}`;
        itemEl.appendChild(img); itemEl.appendChild(span); itemEl.dataset.color = user.color || '#1E90FF';
        listEl.appendChild(itemEl);
    });
    currentQueue = SAMPLE_FALLBACK.slice();
}

setInterval(updateQueue, 1000);
updateQueue();

</script>
</body>
</html>
