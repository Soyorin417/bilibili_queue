<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" name="referrer" content="no-referrer">
<title>OBS 直播排队显示</title>
<link rel="stylesheet" href="/blivedm/webapp/src/assets/queue.css">
<style>
body {
    margin: 0;
    background: transparent;
    font-family: "Microsoft YaHei", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

.empty {
    font-size: 36px;
    color: #aaa;
    text-align: center;
    padding: 20px 0;
}

</style>
</head>
<body>
<div id="preview"></div>

<script>
let currentQueue = [];

// 渲染单个队列项
function createQueueItem(user, index) {
    const item = document.createElement('div');
    item.className = 'queue-item';
    if (user.color) item.style.borderLeftColor = user.color;

    const img = document.createElement('img');
    img.src = user.face || 'default_avatar.png';
    img.alt = user.uname;

    const span = document.createElement('span');
    span.textContent = `${index + 1}. ${user.uname}`;

    item.appendChild(img);
    item.appendChild(span);
    return item;
}

// 渲染队列差异
function renderQueue(queue) {
    const preview = document.getElementById('preview');

    // 队列为空
    if (!queue || queue.length === 0) {
        if (currentQueue.length !== 0) { // 仅当状态变化才更新
            preview.innerHTML = '<div class="empty">（无人）</div>';
            currentQueue = [];
        }
        return;
    }

    // 队列从空变有内容
    if (currentQueue.length === 0) {
        preview.innerHTML = '';
        queue.forEach((user, index) => {
            preview.appendChild(createQueueItem(user, index));
        });
        currentQueue = queue;
        return;
    }

    // 比较差异
    const maxLen = Math.max(currentQueue.length, queue.length);
    for (let i = 0; i < maxLen; i++) {
        const oldUser = currentQueue[i];
        const newUser = queue[i];

        if (!oldUser && newUser) { // 新增
            preview.appendChild(createQueueItem(newUser, i));
        } else if (oldUser && !newUser) { // 删除
            preview.removeChild(preview.childNodes[i]);
        } else if (JSON.stringify(oldUser) !== JSON.stringify(newUser)) { // 更新
            const newItem = createQueueItem(newUser, i);
            preview.replaceChild(newItem, preview.childNodes[i]);
        }
    }

    currentQueue = queue;
}

// 拉取队列 JSON
async function updateQueue() {
    try {
        const res = await fetch('queue.json?_=' + Date.now());
        if (!res.ok) throw new Error(res.statusText);
        const data = await res.json();
        renderQueue(data);
    } catch (e) {
        console.error('读取队列失败', e);
        const preview = document.getElementById('preview');
        if (currentQueue.length !== 0) { // 避免重复刷新
            preview.innerHTML = '<div class="empty">读取队列失败</div>';
            currentQueue = [];
        }
    }
}

// 每 2 秒刷新队列
setInterval(updateQueue, 2000);
updateQueue();
</script>
</body>
</html>
